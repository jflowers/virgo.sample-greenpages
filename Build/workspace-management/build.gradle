version = '1.0'

ant.mkdir(dir: 'build')

task clean(type: Delete) {
    delete 'build'
}

task createSfx << {
	ant.copy(overwrite: true, file: '../set.env.cmd', toDir: 'SfxRoot')
	ant.exec(
		dir: 'SfxRoot',
		executable: 'C:\\Program Files (x86)\\7-Zip\\7z.exe',
		failonerror: false,
		vmlauncher: false,
		resultproperty:"cmdExit",
		outputproperty:"cmdOut",
        errorproperty: "cmdErr"
	) {
		arg(line: 'a')
		arg(line: '-t7z')
		arg(line: '..\\build\\Workspace-Setup.7z')
		arg(line: '.\\')
	}
	
	println "return code:  ${ant.project.properties.cmdExit}"
	println """stderr:
${ant.project.properties.cmdErr}
################################"""
	println """stdout:
${ ant.project.properties.cmdOut}
################################"""
	
	if (ant.project.properties.cmdExit != '0') {
		throw new GradleException('Failed to create 7z file.')
	}
	String copyCommand = 'cmd /C copy /Y /b 7zsd.sfx + SfxRoot\\config.txt + build\\Workspace-Setup.7z build\\Workspace-Setup.exe'
	println copyCommand
	
	String output = copyCommand.execute().text
	println output
	
	if (!(new File('build/Workspace-Setup.exe')).exists()) {
		throw new GradleException('Filed to create sfx file.')
	}
}


task build(dependsOn: ['createSfx']) {}

task all(dependsOn: ['build']) {}